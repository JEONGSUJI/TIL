# 내가 잘 몰라서 쓰는 토이 프로젝트 생성기

뭔가 다 배웠다는데, 뭘 배웠는지 모르겠고, 시작하려니 `mkdir toyproject`하고 멈춰있는 내 모습이 당황스러워 처음부터 복습해보기위해 기록하는 생성기입니다.



**[토이 프로젝트 아이템]**

미정 / Trello 클론한 프론트엔드 프로젝트 결과물을 가지고 백엔드를 구성하는 것과 다른 아이템 중 고민중



**[작업 순서]**

- 배포
  - Django 세팅
  - EC2 세팅
  - DOCKER 세팅
  - Nginx, gunicorn
- 모델링
- 프로젝트 작업 순차 진행

- 문서 작업



## 배포

### Django 세팅

poetry를 이용한 Django setting을 해보려고 합니다.



디렉토리 생성 후 가상환경을 만들 폴더로 이동하겠습니다. 폴더명은 `toyproject`로 하겠습니다.

```python
$ mkdir toyproject
$ cd toyproject
```



우선 Django 개발 환경을 설정하겠습니다. 환경명은 `toyproject-env`로 하겠습니다.

```python
$ pyenv virtualenv 3.7.5 <환경명>
$ pyenv local <환경명>
```



poetry를 활용하여 Django를 설치하겠습니다. poetry 설치방법은 생략하겠습니다.

```python
$ poetry init # no/no/yes
$ poetry add django
```



Django startproject를 해주겠습니다. project 명은 config라고 설정할 것이고, 외부 폴더명은 config에서 app으로 바꾸는 작업을 하겠습니다.

```python
$ django-admin startproject config
$ mv config app
```



추후 서버에서의 설정을 위해 poetry.lock 파일로부터 requirements.txt 생성해놓겠습니다.

```python
$ poetry export -f requirements.txt > requirements.txt
```



이제, pycharm을 실행하겠습니다.

```python
$ pycharm-community .
```



pycharm에서 Interpreter 설정을 해주겠습니다. 순서는 아래와 같습니다.

1) Pycharm > File > Settings > Project:toyproject > Project Interpreter

2) Project Interpreter: <No interpreter> 클릭

3) Show All  > '+' 버튼 클릭 > System Interperter

4) interpreter : 옆 '...' 버튼 클릭 후 `/Users/<home name>/.pyenv/versions/<env name>/bin/python` 경로 찾고 OK버튼 > OK 버튼 클릭



현재 목표는 배포과정을 모두 마치는 것이기 때문에 별도의 어플리케이션을 만드는 작업은 뒤로 미루겠습니다. 이제 migrate 작업을 진행합니다. manage.py가 있는 app 폴더로 이동해 진행합니다.

```python
$ ./manage.py migrate
```



runserver를 통해 admin에 접속해보겠습니다.

```python
$ ./manage.py runserver
```



이제 `http://127.0.0.1:8000/`에 접속하면 Django의 로케트 화면이 우리를 반겨주고 있음을 확인할 수 있습니다.



### EC2 세팅

AWS에서 EC2를 생성합니다. 생성방법과 공개키 생성 및 설정은 django_deployment.md 파일 내 배포 환경 세팅을 참고하세요.



#### SSH

EC2가 생성이 되었다면, 이제 SSH를 사용해 접속해보겠습니다.

```python
$ ssh -i ~/.ssh/[공개키이름].pem ubuntu@[IPv4 퍼블릭 IP]
```



인스턴스 인바운드에 SSH(보안 텔넷) 및 HTTP를 사용하기 위해 인바운드 규칙을 추가해주어야 합니다.

- AWS EC2에 `네트워크 및 보안` 탭에서 `보안 그룹`을 선택하고 인바운드 탭에 `편집` 버튼을 클릭한다.
- `규칙 추가`버튼을 클릭하고 유형: SSH / 소스: 위치무관으로 설정해준 뒤 `저장`한다.
- `규칙 추가`버튼을 클릭하고 유형: HTTP으로 설정해준 뒤 `저장`한다.
- 인바운드 설정에 소스가 ::/0와 0.0.0.0/0 나오면 정상이다.



우선 해당 서버에 필요한 환경을 설치한 후 runserver를 통해 접속이 되는지 확인해봅시다. 해당 서버에 접속한 상태로 아래 코드를 입력해 필요한 환경을 설치합니다.

```python
$ sudo apt update
$ sudo apt dist-upgrade

$ sudo apt install python3.7
# keep the local version currently installed 선택
$ sudo apt install python3-pip
$ pip3 list
$ pip3 install django

$ mkdir projects
$ cd projects

$ mkdir toyproject
$ cd toyproject

$ exit
```



다시 해당 서버에 접속해 runserver를 해봅시다.

```python
$ ssh -i ~/.ssh/[공개키이름].pem ubuntu@[IPv4 퍼블릭 IP]
```

```python
$ cd ~/projects/toyproject/
$ django-admin startproject config .
$ python3 manage.py runserver 0:80
```



브라우저 주소창에 `IPv4 퍼블릭 IP` 입력 시 `DisallowedHost at /`라고 나오면 정상입니다. settings.py를 열고 아래 설정을 추가해줘야합니다. 

```python
$ vim config/settings.py
```

`i` INSERT MODE로 `ALLOWED_HOSTS = ['IPv4 퍼블릭 IP', '*']`으로 수정하고 `ESC` 누른 뒤 `:wq`



```python
$ sudo python3 manage.py runserver 0:80
```

브라우저 주소창에 `IPv4 퍼블릭 IP` 입력 시 장고 로케트 화면 나오면 정상입니다.



지금까지 서버에서 한 작업은 우리가 이전에 Django 프로젝트를 위해 설정한 작업과는 무관했습니다. 이제 우리가 이전에 Django 프로젝트를 위해 설정한 작업을 옮기고 배포해봅시다.



#### SCP

SCP, 시큐어 카피로 이제 toyproject를 복사해봅시다. SCP는 로컬 호스트와 원격 호스트 간 또는 두개의 원격 호스트 간에 컴퓨터 파일을 안전하게 전송하는 수단입니다.

toyproject가 있는 폴더의 <u>한 단계 상위 폴더 경로로 이동한 후 scp 명령어를 작성</u>해야합니다.

```python
$ scp -i ~/.ssh/[공개키이름].pem -r toyproject ubuntu@[IPv4 퍼블릭 IP]:/home/ubuntu/projects
```



새로운 터미널을 다시 해당 서버에 접속해 runserver를 해봅시다.

```python
$ cd ~/projects/toyproject
$ pip3 install -r requirements.txt

# manage.py가 있는 app 디렉터리로 이동
$ cd app
$ sudo python3 manage.py runserver 0:80
```



이제 브라우저에서 `[IPv4 퍼블릭 IP]`에 접속하면 Django의 로케트 화면이 우리를 반겨주고 있음을 확인할 수 있습니다.



매번 로컬에서 소스코드를 업데이트 해야할 때마다 실행해주는 것도 힘드니 local toyproject에 deploy.sh 파일을 생성하여 `./deploy.sh` 코드만 입력하면 자동으로 실행되도록 해봅시다.



```python
# instagram/deploy.sh 파일 생성

#!/usr/bin/env sh
IDENTIFY_FILE="$HOME/.ssh/[공개키이름].pem"
HOST="ubuntu@[IPv4 퍼블릭 IP]"
ORIGIN_SOURCE="$HOME/projects/wps12th/toyproject"
DEST_SOURCE="/home/ubuntu/projects/toyproject"
SSH_CMD="ssh -i ${IDENTIFY_FILE} ${HOST}"

echo "==runserver 배포=="
# 기존 폴더 삭제
echo "1. 기존 폴더 삭제"
${SSH_CMD} sudo rm -rf ${DEST_SOURCE}

# 로컬에 있는 파일 업로드
echo "2. 로컬 파일 업로드"
scp -q -i "${IDENTIFY_FILE}" -r "${ORIGIN_SOURCE}" ${HOST}:${DEST_SOURCE}

echo "Screen 설정"
# 실행중이던 screen 종료
${SSH_CMD} -C 'screen -X -S runserver quit'

# screen 실행
${SSH_CMD} -C 'screen -S runserver -d -m'

# 실행중인 세션에 명령어 전달
${SSH_CMD} -C "screen -r runserver -X stuff 'sudo python3 /home/ubuntu/projects/toyproject/app/manage.py runserver 0:80\n'"

echo "배포완료!"
```



터미널 창에서 `./deploy.sh`를 실행하기 위해서 권한을 바꿔줘야 합니다.

```python
# deploy.sh가 rw-r--r--이기 때문 rwxr--r--로 변경
chmod 744 deploy.sh
./deploy.sh
```



자, 이제 드디어 배포단계의 자동화 1단계를 마쳤습니다.



### DOCKER 세팅



#### 우선 왜 Docker를 써야할까요?

**Docker는 컨테이너 기반의 오픈소스 가상화 플랫폼입니다.** 컨테이너는 다양한 프로그램, 실행환경을 컨테이너로 추상화하고 동일한 인터페이스를 제공해 프로그램의 배포 및 관리를 단순하게 해주기 때문입니다.

아래와 같이 환경세팅을 해야하는데 복잡하고 어려워서 DOCKER를 사용해 대신합니다.

```
WebServer 	-> 	WSGI 	-> 		APP
(Nginx 등)	(gunicorn,uWSGI 등) (Django 등)
```



추가적으로 알아두면 좋을 특징은 아래 글을 확인하세요. 더 자세한 글은 [초보를 위한 Docker 안내서](https://subicura.com/2017/01/19/docker-guide-for-beginners-1.html)를 참고하세요. 아래는 요약입니다.

서버를 관리하는 것은 복잡하고 어렵습니다. 하나의 서버에 여러 개의 프로그램을 설치할 때 서로 사용하는 라이브러리의 버전이 다르거나 동일 포트를 사용하는 경우 설치는 매우 까다로워집니다. DevOps의 등장으로 배포는 더 자주 이루어지고 관리는 더 복잡해졌습다. 새로운 툴은 계속해서 등장하고, 클라우드의 발전으로 설치해야 할 서버가 수백대 이상이 되는 상황에서 Docker가 등장했습니다.

**Container는 격리된 공간에서 process가 동작하는 기술입니다.** 기존의 가상머신은 주로 OS를 가상화해서 사용했는데, 무겁고 느려 운영환경에선 사용하기 어려웠습니다. 이를 개선하기 위해 프로세스를 격리하는 방식이 등장했습니다. 

리눅스 컨테이너는 단순히 프로세스를 격리시키기 때문에 가볍고 빠르게 동작합니다. CPU나 메모리는 딱 프로세스가 필요한 만큼만 추가로 사용하고 성능적으로도 거의 손실이 없습니다. 또한 하나의 서버에 여러개의 컨테이너를 실행하면 서로 영향을 미치지 않고 독립적으로 실행되어 마치 가벼운 VM을 사용하는 느낌을 줍니다.

**Docker 이미지는 컨테이너 실행에 필요한 파일과 설정값등을 포함하고 있는 것으로 상태값을 가지지 않고 변하지 않습니다.** 컨테이너는 이미지를 실행한 상태라고 볼 수 있고 추가되거나 변하는 값은 컨테이너에 저장됩니다. 말그대로 이미지는 컨테이너를 실행하기 위한 모든 정보를 가지고 있기 때문에 더이상 의존성 파일을 컴파일하고 이것저것 설치할 필요가 없습니다. 도커 이미지는 Docker hub에 등록하거나 Docker Registry 저장소를 직접 만들어 관리할 수 있습니다.

**Docker는 `Dockerfile`라는 파일에 자체 DSL언어를 이용해 이미지 생성과정을 적습니다.**

**Docker는 Docker Hub를 통해 공개 image를 무료로 관리해줍니다.**



[Docker 설치과정](https://docs.docker.com/install/linux/docker-ce/ubuntu/)은 생략하겠습니다.

(설치과정 참고: django_deployment3.md 설치하고 컨테이너 실행하기)



#### `Dockerfile` 생성

이제 우리는 `Dockerfile`을 만들어보겠습니다.

toyproject 루트 폴더에 `Dockerfile`을 생성하고 아래 내용을 입력하세요.

```dockerfile
# python:3.7-slim에 사용하는걸 모두 쓰겠다.
FROM        python:3.7-slim
# RUN 마다 컨테이너 하나가 생긴다.
RUN         apt -y update && apt -y dist-upgrade && apt -y autoremove

# requirements를 /tmp에 복사 후, pip install실행
COPY        ./requirements.txt /tmp/
RUN         pip install -r /tmp/requirements.txt

# 소스코드 복사 후 runserver
COPY        . /srv/toyproject
# WORKDIR는 cd의 의미이다.
WORKDIR     /srv/toyproject/app
CMD         python manage.py runserver 0:8000
```



다음으로, pycharm에서 `plugin ignore`와 `GitToolBox` 설치하세요.

toyproject 루트 폴더에 `.dockerignore`를 생성하고 아래 내용을 입력해주세요.

```
/.git
/.media
/.static
/secrets.json
/deploy*.py
/deploy*.sh
```



Docker 설치 확인하기

```python
$ docker version
```



#### docker build & run 하기

bulid 명령으로 이제 docker image를 생성해봅시다. toyproject 폴더에서 실행해주세요.  `-t`는 `--tag`옵션으로 이미지 이름과 태그를 설정할 수 있습니다. 이미지 이름만 설정하면 태그는 latest로 설정됩니다. `-f`는 dockerfile 위치 설정입니다.

```python
$ docker build -t toyproject -f Dockerfile .
$ docker run --rm -it -p 8001:8000 instagram
```



> **만약 image가 잘못 만들어졌다면?**
>
> 만들어진 docker image 확인하기
>
> ```
> docker images
> ```
>
> docker image를 지우는 코드
>
> ```
> docker rmi [REPOSITORY]
> ```
>



---

추후 진행



https://hub.docker.com/ 가입하고, Docker login을 진행합니다.

서버 접속이 된 터미널에 아래 명령어를 입력하세요.

```python
$ docker login
# hub.docker.com에 가입한 id/pw 입력
# 권한에 문제가 발생한다고 나타나는 경우 명령어 앞에 sudo를 붙여 입력
```



우선 DOCKER IMAGE에 SECRET 값을 넣지 않기 위해 secrets.json을 루트 폴더에 만들고 settings.py에 불러오는 작업을 진행해보겠습니다.



secrets.json 파일을 생성하고 아래와 같은 json 형식으로 입력해주세요.

```json
{
    "abc" : "abc"
}
```



settings.py에서 해당 값을 읽어 봅시다.

```python
# settings.py
# secrets.json파일이 ROOT_DIR에 있는 경우

ROOT_DIR = os.path.dirname(BASE_DIR)

import json
secrets_path = os.path.join(ROOT_DIR, 'secrets.json')
json_data = json.load(open(secrets_path))

# 사용하고자 하는 곳에
sample = json_data['json에 입력한 key값']
```



### docker hub에 push하기

https://hub.docker.com/ 에 create repository를 한 뒤

```python
$ docker tag instagram ID/reponame:tagname
$ docker push ID/reponame
```

(ID와 reponame은 hub.docker.com ID와 reponame 의미)



nginx할 때 dockerfile 추가

```
# python:3.7-slim에 사용하는걸 모두 쓰겠다.
FROM        python:3.7-slim
# RUN 마다 컨테이너 하나가 생긴다.
RUN         apt -y update && apt -y dist-upgrade && apt -y autoremove
RUN         apt -y install nginx

# requirements를 /tmp에 복사 후, pip install실행
# 2. poetry export로 생성된 requirements.txt를 적절히 복사
COPY        ./requirements.txt /tmp/
RUN         pip install -r /tmp/requirements.txt

# 소스코드 복사 후 runserver
COPY        . /srv/instagram
WORKDIR     /srv/instagram/app

# nginx 설정파일 복사
RUN         rm /etc/nginx/sites-enabled/default
RUN         cp /srv/instagram/.config/instagram.nginx /etc/nginx/sites-enabled/

# 로그폴더 생성
RUN     mkdir /var/log/gunicorn

# collectstatic
#RUN         python manage.py collectstatic --noinput

#CMD         python manage.py runserver 0:8000
CMD         /bin/bash
```





슈퍼유저 생성 

이제 로그인을 위해 슈퍼 유저 계정을 생성해보겠습니다. 

```
$ ./manage.py createsuperuser
```



애플리케이션 생성